<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I'm hungry | Customer App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600;700&display=swap');
        body { 
            font-family: 'Hind Siliguri', sans-serif; 
            background-color: #f8f9fa; 
            padding-bottom: 90px; 
            -webkit-tap-highlight-color: transparent;
        }
        .tab-content { display: none; }
        .active-tab { display: block; }
        .nav-active { color: #ef4444; border-top: 3px solid #ef4444; }
        .msg-box { max-width: 80%; padding: 10px 15px; font-weight: 600; font-size: 14px; margin-bottom: 2px; }
        .msg-customer { background-color: #ef4444; color: white; align-self: flex-end; border-radius: 18px 18px 2px 18px; }
        .msg-rider { background-color: #ffffff; color: #1f2937; align-self: flex-start; border-radius: 18px 18px 18px 2px; border: 1px solid #e5e7eb; }
        
        #tracking-map, #picker-map { height: 100%; width: 100%; z-index: 1; background: #e5e7eb; }
        .map-wrapper { position: relative; flex: 1; width: 100%; overflow: hidden; }
        .center-pin {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%);
            z-index: 1000;
            pointer-events: none;
            color: #ef4444;
            font-size: 40px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .cart-float { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .tip-btn-active { background-color: #ef4444 !important; color: white !important; border-color: #ef4444 !important; }

        /* Notification Toast Style */
        #notification-toast {
            position: fixed;
            top: -120px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: white;
            z-index: 3000;
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid #ef4444;
        }
        #notification-toast.show { top: 20px; }
    </style>
</head>
<body onclick="unlockAudio()" ontouchstart="unlockAudio()">

    <!-- Notification Toast -->
    <div id="notification-toast" onclick="this.classList.remove('show')">
        <div class="bg-red-100 text-red-600 w-10 h-10 rounded-full flex items-center justify-center shrink-0">
            <i class="fas fa-comment-dots"></i>
        </div>
        <div class="flex-1">
            <h4 id="notif-title" class="font-black text-xs text-red-600 uppercase">মেসেজ আপডেট</h4>
            <p id="notif-msg" class="text-sm font-bold text-gray-700 leading-tight">নতুন মেসেজ এসেছে।</p>
        </div>
    </div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 min-h-screen flex items-center justify-center p-6 bg-red-600 z-[1000]">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-w-md text-center">
            <h2 class="text-4xl font-black text-red-600 mb-2 italic">খিদে লাগছে</h2>
            <div id="login-form">
                <input type="number" id="login-phone" placeholder="ফোন নম্বর" class="w-full p-4 mb-4 bg-gray-100 rounded-2xl outline-none text-center font-bold text-lg">
                <button onclick="loginUser()" class="w-full bg-red-600 text-white py-4 rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition-transform">লগইন</button>
                <p class="mt-6 text-center text-gray-500">নতুন? <a href="#" onclick="toggleAuth(false)" class="text-red-600 font-bold underline">সাইন আপ</a></p>
            </div>
            <div id="signup-form" class="hidden space-y-3">
                <input type="text" id="reg-name" placeholder="আপনার নাম" class="w-full p-4 bg-gray-100 rounded-2xl font-bold outline-none text-center">
                <input type="number" id="reg-phone" placeholder="ফোন নম্বর" class="w-full p-4 bg-gray-100 rounded-2xl font-bold outline-none text-center">
                <button onclick="registerUser()" class="w-full bg-red-600 text-white py-4 rounded-2xl font-bold text-xl">অ্যাকাউন্ট খুলুন</button>
                <p class="mt-4 text-center"><a href="#" onclick="toggleAuth(true)" class="text-gray-400 font-bold">লগইন এ ফিরে যান</a></p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app-content" class="hidden">
        <header class="bg-white p-4 sticky top-0 z-20 shadow-sm flex justify-between items-center border-b">
            <div class="flex items-center gap-3" onclick="switchTab('profile')">
                <div class="bg-red-600 p-2 rounded-xl text-white"><i class="fas fa-map-marker-alt"></i></div>
                <div class="flex-1 overflow-hidden">
                    <p class="text-[10px] text-red-500 uppercase font-black">DELIVERY TO</p>
                    <h1 id="user-address-header" class="text-xs font-bold truncate max-w-[150px] text-gray-700 italic">ঠিকানা নির্বাচন করুন...</h1>
                </div>
            </div>
            <button onclick="openCart()" class="relative p-3 bg-red-50 rounded-2xl">
                <i class="fas fa-shopping-basket text-red-600 text-xl"></i>
                <span id="cart-badge" class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] px-1.5 py-0.5 rounded-full border-2 border-white hidden">0</span>
            </button>
        </header>

        <!-- Home -->
        <section id="tab-home" class="tab-content active-tab p-4">
            <div id="time-status-banner" class="mb-4 text-center p-2 rounded-xl font-bold text-[10px] uppercase"></div>
            
            <div class="mb-4 relative">
                <input type="text" id="res-search" oninput="filterRestaurants()" placeholder="রেস্টুরেন্ট খুঁজুন..." class="w-full p-4 pl-12 bg-white border border-gray-200 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-red-500 transition-all shadow-sm">
                <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>

            <div id="promo-banner" class="mb-4 p-4 bg-red-600 text-white rounded-2xl font-black text-center shadow-lg hidden animate-pulse"></div>
            
            <h2 class="text-xl font-black mb-4 text-gray-800 flex items-center gap-2"><i class="fas fa-store text-red-600"></i> রেস্টুরেন্ট সমূহ</h2>
            <div id="restaurant-list" class="space-y-4"></div>
        </section>

        <!-- Order History -->
        <section id="tab-orders" class="tab-content p-4">
            <h2 class="text-2xl font-black mb-4">My order</h2>
            <div id="my-orders-list" class="space-y-4 pb-10"></div>
        </section>

        <!-- Profile -->
        <section id="tab-profile" class="tab-content p-4 text-center">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border mb-6 text-left">
                <h3 id="prof-name" class="font-black text-xl text-gray-800 text-center">-</h3>
                <p id="prof-phone" class="text-red-500 font-bold text-sm mb-4 text-center">-</p>
                <div class="border-t pt-4">
                    <p class="text-[10px] font-black text-gray-400 uppercase mb-3">আমার ঠিকানাগুলো</p>
                    <div id="address-list" class="space-y-2"></div>
                    <button onclick="openAddressPicker()" class="w-full mt-4 py-3 border-2 border-dashed border-red-500 text-red-500 rounded-2xl font-black text-xs">+ নতুন ঠিকানা যোগ করুন</button>
                </div>
            </div>
            <button onclick="logout()" class="w-full bg-red-50 text-red-600 py-4 rounded-2xl font-black">লগআউট</button>
        </section>

        <!-- Tracking View -->
        <div id="tracking-view" class="fixed inset-0 bg-white z-[300] hidden flex flex-col">
            <div class="p-4 border-b flex items-center gap-4 bg-white sticky top-0 z-10">
                <button onclick="closeTracking()"><i class="fas fa-arrow-left text-red-600 text-xl"></i></button>
                <h2 class="font-black">রাইডার ট্র্যাকিং</h2>
            </div>
            <div class="map-wrapper">
                <div id="tracking-map"></div>
            </div>
        </div>

        <!-- Chat View -->
        <div id="chat-view" class="fixed inset-0 bg-white z-[250] hidden flex flex-col">
            <div class="p-4 border-b flex items-center justify-between bg-white shadow-sm">
                <div class="flex items-center gap-4">
                    <button onclick="closeChat()"><i class="fas fa-arrow-left text-red-600 text-xl"></i></button>
                    <h2 class="font-black">Rider Chat</h2>
                </div>
                <button onclick="playChatSound()" id="chat-sound-btn" class="w-10 h-10 rounded-full bg-red-50 text-red-600 flex items-center justify-center">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2 bg-gray-50"></div>
            <div class="p-4 border-t bg-white flex gap-2">
                <input type="text" id="chat-input" placeholder="Write..." class="flex-1 p-4 bg-gray-100 rounded-2xl outline-none font-bold">
                <button onclick="sendChatMessage()" class="bg-red-600 text-white w-12 h-12 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <!-- Menu View -->
        <div id="menu-view" class="fixed inset-0 bg-white z-40 hidden overflow-y-auto">
            <div class="p-4 flex items-center gap-4 border-b sticky top-0 bg-white z-10">
                <button onclick="closeMenu()"><i class="fas fa-chevron-left text-xl text-red-600"></i></button>
                <h2 id="menu-res-name" class="text-lg font-black text-gray-800">মেনু</h2>
            </div>
            <div id="menu-items-list" class="p-4 space-y-4 pb-32"></div>
            <div id="floating-cart" class="fixed bottom-24 left-4 right-4 bg-red-600 text-white p-4 rounded-2xl shadow-2xl flex justify-between items-center hidden cart-float z-50">
                <div>
                    <p id="float-cart-count" class="text-xs font-bold">০টি আইটেম</p>
                    <p id="float-cart-total" class="text-lg font-black">মোট: ৳০</p>
                </div>
                <button onclick="openCart()" class="bg-white text-red-600 px-6 py-2 rounded-xl font-black text-sm shadow-md">চেকআউট</button>
            </div>
        </div>

        <!-- Cart Modal -->
        <div id="cart-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end">
            <div class="bg-white w-full rounded-t-[3rem] p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-black text-gray-800">কার্ট</h3>
                    <button onclick="openCart(false)" class="bg-gray-100 p-2 rounded-full text-gray-400"><i class="fas fa-times"></i></button>
                </div>
                <div id="cart-items-box" class="space-y-3 mb-6"></div>
                
                <div class="border-t border-dashed pt-4 space-y-3">
                    <div class="flex justify-between font-bold text-gray-400 text-xs">
                        <span>আইটেম মূল্য:</span>
                        <span>৳ <span id="sub-total">০</span></span>
                    </div>
                    <div class="flex flex-col gap-0.5 border-b border-dashed pb-3">
                        <div class="flex justify-between font-bold text-red-500 text-sm">
                            <span>ডেলিভারি চার্জ:</span>
                            <span id="delivery-charge-display">৳ ০</span>
                        </div>
                        <p id="delivery-info-text" class="text-[10px] font-bold text-gray-400 italic text-right"></p>
                    </div>

                    <!-- Rider Tip Section -->
                    <div class="py-2">
                        <p class="text-[10px] font-black text-gray-400 uppercase mb-2">রাইডারকে টিপ দিন (ঐচ্ছিক)</p>
                        <div class="flex justify-between gap-2" id="tip-options">
                            <button onclick="setTip(20)" class="tip-btn flex-1 py-2 border rounded-xl text-xs font-bold text-gray-500 bg-gray-50">৳২০</button>
                            <button onclick="setTip(40)" class="tip-btn flex-1 py-2 border rounded-xl text-xs font-bold text-gray-500 bg-gray-50">৳৪০</button>
                            <button onclick="setTip(60)" class="tip-btn flex-1 py-2 border rounded-xl text-xs font-bold text-gray-500 bg-gray-50">৳৬০</button>
                            <button onclick="setTip(80)" class="tip-btn flex-1 py-2 border rounded-xl text-xs font-bold text-gray-500 bg-gray-50">৳৮০</button>
                            <button onclick="setTip(100)" class="tip-btn flex-1 py-2 border rounded-xl text-xs font-bold text-gray-500 bg-gray-50">৳১০০</button>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mb-6 font-black text-2xl text-gray-800 pt-2 border-t border-dashed">
                        <span>মোট বিল:</span>
                        <span id="cart-total-price">৳ ০</span>
                    </div>
                    <button onclick="placeOrder()" class="w-full bg-red-600 text-white py-5 rounded-3xl font-black text-xl shadow-xl active:scale-95 transition-all">অর্ডার নিশ্চিত করুন</button>
                </div>
            </div>
        </div>

        <!-- Address Picker Modal -->
        <div id="address-picker-modal" class="fixed inset-0 bg-white z-[500] hidden flex flex-col">
            <div class="map-wrapper">
                <div id="picker-map"></div>
                <div class="center-pin">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
            </div>
            <div class="p-6 bg-white rounded-t-[2.5rem] shadow-2xl -mt-8 z-10 overflow-y-auto max-h-[65vh] border-t">
                
                <div class="flex items-center gap-2 mb-4 bg-gray-50 p-3 rounded-xl border border-dashed">
                    <p id="picked-address-text" class="text-sm font-bold text-gray-700 flex-1 truncate italic">লোকেশন খুঁজছি...</p>
                    <div class="flex gap-1">
                        <button onclick="copyToClipboard('picked-address-text')" class="text-red-600 p-2 bg-white rounded-lg shadow-sm border"><i class="fas fa-copy"></i></button>
                        <button onclick="pasteToText('picked-address-text')" class="text-red-600 p-2 bg-white rounded-lg shadow-sm border"><i class="fas fa-paste"></i></button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div class="relative flex items-center">
                        <button onclick="pasteFromClipboard('addr-label')" class="absolute left-2 text-red-600 p-2 z-10"><i class="fas fa-paste text-xs"></i></button>
                        <input type="text" id="addr-label" placeholder="ঠিকানার নাম (বাসা)" class="w-full p-4 pl-10 bg-gray-100 rounded-xl outline-none font-bold text-sm">
                    </div>
                    <div class="relative flex items-center">
                        <input type="text" id="addr-flat" placeholder="ফ্ল্যাট/বাড়ি নং" class="w-full p-4 bg-gray-100 rounded-xl outline-none font-bold text-sm pr-10">
                        <button onclick="pasteFromClipboard('addr-flat')" class="absolute right-2 text-red-600 p-2"><i class="fas fa-paste text-xs"></i></button>
                    </div>
                </div>

                <div class="relative mb-4">
                    <textarea id="addr-instructions" placeholder="রাইডারের জন্য কোনো নির্দেশনা (ঐচ্ছিক)..." class="w-full p-4 bg-gray-100 rounded-xl outline-none font-bold text-sm h-20 resize-none pr-10"></textarea>
                    <button onclick="pasteFromClipboard('addr-instructions')" class="absolute top-2 right-2 text-red-600 p-2"><i class="fas fa-paste text-xs"></i></button>
                </div>

                <button onclick="saveAddressToFirebase()" class="w-full bg-red-600 text-white py-4 rounded-2xl font-black text-lg shadow-lg active:scale-95 transition-all">Confirm address</button>
                <button onclick="closeAddressPicker()" class="w-full mt-4 text-gray-400 font-bold text-sm underline pb-4 text-center">Cancel</button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around py-3 shadow-2xl z-50">
            <button onclick="switchTab('home')" id="nav-home" class="flex flex-col items-center nav-active px-6"><i class="fas fa-home text-xl"></i><span class="text-[10px] font-bold">Home</span></button>
            <button onclick="switchTab('orders')" id="nav-orders" class="flex flex-col items-center text-gray-300 px-6"><i class="fas fa-receipt text-xl"></i><span class="text-[10px] font-bold">Order</span></button>
            <button onclick="switchTab('profile')" id="nav-profile" class="flex flex-col items-center text-gray-300 px-6"><i class="fas fa-user-circle text-xl"></i><span class="text-[10px] font-bold">Profile</span></button>
        </nav>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD_TytbX1kd4SKQ5uHZfd5XVGwdw0gzUOE",
            authDomain: "feeling-hungry-102a9.firebaseapp.com",
            databaseURL: "https://feeling-hungry-102a9-default-rtdb.firebaseio.com",
            projectId: "feeling-hungry-102a9",
            storageBucket: "feeling-hungry-102a9.firebasestorage.app",
            messagingSenderId: "736201265500",
            appId: "1:736201265500:web:7b7064b314247c02ad7199"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = null, cart = [], activeDeliveryCharge = 0, currentResName = "", currentTip = 0;
        let currentKM = 0, currentPerKM = 0, currentBaseFees = 0, selectedLat = null, selectedLng = null;
        let trackMap = null, riderMarker = null, activeChatOrderId = null, pickerMap = null;
        let allRestaurants = [];
        let monitoredOrders = new Set();
        let appStartedAt = Date.now();

        // --- AUDIO & NOTIFICATION LOGIC ---
        let audioUnlocked = false;
        const beepBeat = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
        
        function unlockAudio() {
            if (audioUnlocked) return;
            beepBeat.play().then(() => {
                beepBeat.pause();
                beepBeat.currentTime = 0;
                audioUnlocked = true;
            }).catch(() => {});
        }

        function playChatSound() {
            if(!audioUnlocked) return;
            beepBeat.currentTime = 0;
            const playPromise = beepBeat.play();
            if (playPromise !== undefined) {
                playPromise.catch(() => {});
            }
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]); 
        }

        function showNotification(title, message) {
            const toast = document.getElementById('notification-toast');
            document.getElementById('notif-title').innerText = title;
            document.getElementById('notif-msg').innerText = message;
            
            playChatSound();
            toast.classList.add('show');
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }

        // Listen for Order status changes AND Global Rider Messages
        function setupNotificationListeners() {
            if (!currentUser) return;
            
            let orderStatusTracker = {};

            db.ref('orders').orderByChild('customerPhone').equalTo(currentUser.phone).on('value', snap => {
                snap.forEach(child => {
                    const order = child.val();
                    const orderId = child.key;
                    
                    // 1. Monitor Order Status Changes
                    if (orderStatusTracker[orderId] && orderStatusTracker[orderId] !== order.status) {
                        let statusMsg = "";
                        switch(order.status) {
                            case 'ACCEPTED': statusMsg = "আপনার অর্ডারটি গ্রহণ করা হয়েছে!"; break;
                            case 'ASSIGNED': statusMsg = "অর্ডারের জন্য রাইডার পাওয়া গেছে।"; break;
                            case 'PICKED_UP': statusMsg = "রাইডার খাবার নিয়ে রওনা দিয়েছে।"; break;
                            case 'DELIVERED': statusMsg = "ডেলিভারি সম্পন্ন হয়েছে!"; break;
                            case 'CANCELLED': statusMsg = "অর্ডারটি বাতিল করা হয়েছে।"; break;
                        }
                        if (statusMsg) showNotification("অর্ডার আপডেট", statusMsg);
                    }
                    orderStatusTracker[orderId] = order.status;

                    // 2. Monitor New Rider Messages for each order
                    if (!monitoredOrders.has(orderId)) {
                        monitoredOrders.add(orderId);
                        db.ref(`chats/${orderId}`).on('child_added', msgSnap => {
                            const msg = msgSnap.val();
                            // Only notify if sender is rider AND it happened after app was opened
                            if (msg.sender === 'rider' && msg.timestamp > appStartedAt) {
                                showNotification("রাইডার মেসেজ পাঠিয়েছেন", msg.text);
                            }
                        });
                    }
                });
            });
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            if(!lat1 || !lon1 || !lat2 || !lon2) return 0;
            const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }

        function toggleAuth(l) { document.getElementById('login-form').classList.toggle('hidden', !l); document.getElementById('signup-form').classList.toggle('hidden', l); }

        function loginUser(pInput = null) {
            const p = pInput || document.getElementById('login-phone').value;
            if(!p) return;
            db.ref('customers/' + p).once('value', snap => {
                if(snap.exists()) {
                    currentUser = snap.val();
                    localStorage.setItem('khide_user_phone', p);
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app-content').classList.remove('hidden');
                    updateHeaderAddress();
                    renderSavedAddresses();
                    setupApp();
                    setupNotificationListeners();
                } else if (!pInput) { alert("ইউজার পাওয়া যায়নি!"); }
            });
        }

        function setupApp() {
            db.ref('appSettings').on('value', snap => {
                const s = snap.val() || {};
                const promo = document.getElementById('promo-banner');
                if(s.noticeText) { promo.innerText = s.noticeText; promo.classList.remove('hidden'); }
                document.getElementById('time-status-banner').innerText = s.isOpen ? "● ডেলিভারি খোলা আছে" : "● এখন ডেলিভারি বন্ধ";
            });
            db.ref('restaurants').on('value', snap => {
                allRestaurants = [];
                snap.forEach(c => { allRestaurants.push({id: c.key, ...c.val()}); });
                renderRestaurantList(allRestaurants);
            });
        }

        function filterRestaurants() {
            const query = document.getElementById('res-search').value.toLowerCase();
            const filtered = allRestaurants.filter(r => r.name.toLowerCase().includes(query));
            renderRestaurantList(filtered);
        }

        function renderRestaurantList(list) {
            let h = ""; 
            list.forEach(r => { 
                h += `<div onclick="openMenu('${r.idNo}', '${r.name}')" class="bg-white p-4 border rounded-3xl flex items-center gap-4 mb-3 shadow-sm active:scale-95 transition-all"><div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-red-600 font-bold">${r.name[0]}</div><div class="flex-1"><h4 class="font-black text-gray-800">${r.name}</h4></div></div>`; 
            });
            document.getElementById('restaurant-list').innerHTML = h || `<p class="text-center text-gray-400 font-bold py-10">পাওয়া যায়নি!</p>`;
        }

        async function openMenu(resIdNo, resName) {
            currentResName = resName;
            let resData = null;
            await db.ref('restaurants').once('value', s => { s.forEach(c => { if(c.val().idNo === resIdNo) resData = c.val(); }); });
            const settingsSnap = await db.ref('appSettings').once('value');
            const s = settingsSnap.val() || {};
            const adminBase = parseFloat(s.adminDeliveryFee) || 0;
            const perKm = parseFloat(s.perKmFee) || 0;
            let userCoords = null;
            if(currentUser.addresses) { userCoords = Object.values(currentUser.addresses).find(a => a.fullAddress === currentUser.activeAddress); }
            if (resData && resData.lat && userCoords && userCoords.lat) {
                const dist = getDistance(userCoords.lat, userCoords.lng, resData.lat, resData.lng);
                currentKM = dist.toFixed(2);
                currentPerKM = perKm;
                currentBaseFees = adminBase + (parseFloat(resData.deliveryCharge) || 0);
                activeDeliveryCharge = Math.round(currentBaseFees + (dist * perKm));
            } else { activeDeliveryCharge = parseFloat(resData?.deliveryCharge) || 0; currentKM = 0; }
            document.getElementById('menu-view').classList.remove('hidden');
            document.getElementById('menu-res-name').innerText = resName;
            db.ref('menus/' + resIdNo).once('value', snap => {
                let h = ""; snap.forEach(c => { const item = c.val(); h += `<div class="bg-white p-3 rounded-3xl border flex items-center gap-4 mb-3 shadow-sm"><img src="${item.image}" class="w-16 h-16 rounded-xl object-cover"><div class="flex-1"><h4 class="font-black">${item.name}</h4><span class="text-red-600 font-bold">৳${item.price}</span></div><button onclick="addToCart('${c.key}', '${item.name}', ${item.price})" class="bg-red-600 text-white px-5 py-2 rounded-xl font-bold">+ Add</button></div>`; });
                document.getElementById('menu-items-list').innerHTML = h;
            });
        }

        function addToCart(id, name, price) { cart.push({id, name, price}); updateFloatingCart(); }
        function updateFloatingCart() {
            const bar = document.getElementById('floating-cart');
            if(cart.length > 0) {
                bar.classList.remove('hidden');
                const sub = cart.reduce((a, b) => a + b.price, 0);
                document.getElementById('float-cart-count').innerText = cart.length + "টি আইটেম";
                document.getElementById('float-cart-total').innerText = "মোট: ৳" + (sub + activeDeliveryCharge);
            } else bar.classList.add('hidden');
            document.getElementById('cart-badge').innerText = cart.length;
            document.getElementById('cart-badge').classList.toggle('hidden', cart.length === 0);
        }

        function setTip(amount) {
            if(currentTip === amount) currentTip = 0;
            else currentTip = amount;
            
            document.querySelectorAll('.tip-btn').forEach(btn => {
                btn.classList.remove('tip-btn-active');
                if(parseInt(btn.innerText.replace('৳', '')) === currentTip) btn.classList.add('tip-btn-active');
            });
            updateCartPrice();
        }

        function updateCartPrice() {
            const sub = cart.reduce((a, b) => a + b.price, 0);
            document.getElementById('sub-total').innerText = sub;
            document.getElementById('cart-total-price').innerText = "৳ " + (sub + activeDeliveryCharge + currentTip);
        }

        function openCart(s = true) {
            document.getElementById('cart-modal').classList.toggle('hidden', !s);
            if(s) {
                currentTip = 0; 
                document.querySelectorAll('.tip-btn').forEach(btn => btn.classList.remove('tip-btn-active'));
                updateCartPrice();
                document.getElementById('delivery-charge-display').innerText = "৳ " + activeDeliveryCharge;
                const infoText = document.getElementById('delivery-info-text');
                infoText.innerText = currentKM > 0 ? `(${currentKM} কি.মি. × ৳${currentPerKM} + ৳${currentBaseFees} বেস)` : `(ফিক্সড ডেলিভারি চার্জ)`;
                document.getElementById('cart-items-box').innerHTML = cart.map((item, i) => `<div class="flex justify-between p-3 bg-gray-50 rounded-xl mb-2 font-bold text-sm"><span>${item.name}</span><button onclick="removeFromCart(${i})" class="text-red-500 font-bold">Delete</button></div>`).join('');
            }
        }

        function removeFromCart(i) { cart.splice(i, 1); updateFloatingCart(); openCart(cart.length > 0); }

        function placeOrder() {
            if(currentUser.activeAddress === "ঠিকানা সেট করা নেই") { alert("প্রোফাইল থেকে ঠিকানা সেট করুন!"); return; }
            const sub = cart.reduce((a, b) => a + b.price, 0);
            db.ref('orders').push({ 
                customerPhone: currentUser.phone, 
                customerName: currentUser.name, 
                address: currentUser.activeAddress, 
                restaurantName: currentResName, 
                items: cart, 
                deliveryCharge: activeDeliveryCharge, 
                tip: currentTip,
                total: sub + activeDeliveryCharge + currentTip, 
                status: "PENDING", 
                timestamp: firebase.database.ServerValue.TIMESTAMP 
            })
            .then(() => { cart = []; currentTip = 0; updateFloatingCart(); openCart(false); closeMenu(); switchTab('orders'); });
        }

        function loadMyOrders() {
            db.ref('orders').on('value', snap => {
                let data = [];
                snap.forEach(c => { if(c.val().customerPhone === currentUser.phone) data.push({id: c.key, ...c.val()}); });
                document.getElementById('my-orders-list').innerHTML = data.reverse().map(o => `
                    <div class="bg-white p-5 rounded-[2rem] border shadow-sm mb-4">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[10px] font-black bg-gray-100 px-3 py-1 rounded-full text-gray-500">#${o.id.slice(-5).toUpperCase()}</span>
                            <span class="text-[10px] font-black px-2 py-1 rounded-full bg-red-50 text-red-600 uppercase">${o.status}</span>
                        </div>
                        <h4 class="font-black text-gray-800 text-lg">${o.restaurantName}</h4>
                        <div class="flex justify-between items-center mt-4 pt-4 border-t border-dashed">
                            <span class="font-black text-xl">৳${o.total}</span>
                            <div class="flex gap-2">
                                ${o.status !== 'DELIVERED' ? `<button onclick="openChat('${o.id}')" class="bg-red-50 text-red-600 px-4 py-2 rounded-xl text-xs font-black shadow-sm">Chat</button>` : ''}
                                ${(o.status === 'ACCEPTED' || o.status === 'ASSIGNED' || o.status === 'PICKED_UP') ? `<button onclick="openTracking('${o.id}')" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-xs font-black shadow-sm">Track</button>` : ''}
                            </div>
                        </div>
                    </div>`).join('');
            });
        }

        function openTracking(orderId) {
            document.getElementById('tracking-view').classList.remove('hidden');
            if (!trackMap) {
                trackMap = L.map('tracking-map', { zoomControl: false }).setView([23.8103, 90.4125], 16);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap'
                }).addTo(trackMap);
            }
            db.ref(`orders/${orderId}`).on('value', snap => {
                const o = snap.val();
                if (o && o.riderId) {
                    db.ref(`riders/${o.riderId}`).on('value', rSnap => {
                        const r = rSnap.val();
                        if (r && r.lat) {
                            if (riderMarker) riderMarker.setLatLng([r.lat, r.lng]);
                            else riderMarker = L.marker([r.lat, r.lng]).addTo(trackMap);
                            trackMap.panTo([r.lat, r.lng]);
                        }
                    });
                }
            });
            setTimeout(() => trackMap.invalidateSize(), 300);
        }

        function closeTracking() { document.getElementById('tracking-view').classList.add('hidden'); }
        
        let localChatListener = null;

        function openChat(id) {
            activeChatOrderId = id; 
            document.getElementById('chat-view').classList.remove('hidden');
            if(localChatListener) localChatListener.off();
            
            localChatListener = db.ref(`chats/${id}`);
            localChatListener.on('value', s => {
                let h = ""; 
                s.forEach(m => {
                    const msg = m.val();
                    h += `<div class="flex flex-col ${msg.sender === 'customer' ? 'items-end' : 'items-start'}">
                            <div class="msg-box ${msg.sender === 'customer' ? 'msg-customer' : 'msg-rider'}">${msg.text}</div>
                          </div>`;
                });
                const b = document.getElementById('chat-messages'); 
                b.innerHTML = h; 
                b.scrollTop = b.scrollHeight;
            });
        }

        function sendChatMessage() { 
            const i = document.getElementById('chat-input'); 
            if(!i.value.trim()) return; 
            db.ref(`chats/${activeChatOrderId}`).push({ 
                sender: 'customer', 
                text: i.value.trim(), 
                timestamp: Date.now() 
            }); 
            i.value = ""; 
        }

        function closeChat() { 
            if(localChatListener) localChatListener.off(); 
            document.getElementById('chat-view').classList.add('hidden'); 
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active-tab'));
            document.getElementById('tab-' + t).classList.add('active-tab');
            document.querySelectorAll('nav button').forEach(b => b.classList.replace('nav-active', 'text-gray-300'));
            document.getElementById('nav-' + t).classList.replace('text-gray-300', 'nav-active');
            if(t === 'orders') loadMyOrders();
        }

        function updateHeaderAddress() { document.getElementById('user-address-header').innerText = currentUser.activeAddress; document.getElementById('prof-name').innerText = currentUser.name; document.getElementById('prof-phone').innerText = currentUser.phone; }
        
        function renderSavedAddresses() {
            const list = document.getElementById('address-list'); let h = "";
            if(currentUser.addresses) Object.values(currentUser.addresses).forEach(a => { h += `<div onclick="db.ref('customers/${currentUser.phone}/activeAddress').set('${a.fullAddress}').then(()=>location.reload())" class="p-3 border rounded-xl mb-2 text-xs font-bold ${currentUser.activeAddress === a.fullAddress ? 'bg-red-50 border-red-500' : ''} shadow-sm">${a.label}</div>`; });
            list.innerHTML = h || "<p class='text-xs text-gray-400'>ঠিকানা নেই</p>";
        }

        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text).then(() => alert("কপি হয়েছে!"));
        }

        function pasteToText(elementId) {
            navigator.clipboard.readText().then(text => {
                if(text) document.getElementById(elementId).innerText = text;
            }).catch(() => alert("অনুমতি নেই!"));
        }

        function pasteFromClipboard(inputId) {
            navigator.clipboard.readText().then(text => {
                if(text) document.getElementById(inputId).value = text;
            }).catch(() => alert("পেস্ট করার অনুমতি নেই!"));
        }

        function openAddressPicker() {
            document.getElementById('address-picker-modal').classList.remove('hidden');
            if (!pickerMap) {
                pickerMap = L.map('picker-map', { zoomControl: false }).setView([23.8103, 90.4125], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap'
                }).addTo(pickerMap);
                
                pickerMap.on('move', () => document.getElementById('picked-address-text').innerText = "অবস্থান খুঁজছি...");
                pickerMap.on('moveend', () => getAddress(pickerMap.getCenter().lat, pickerMap.getCenter().lng));
                getAddress(23.8103, 90.4125);
            }
            setTimeout(() => pickerMap.invalidateSize(), 300);
        }

        async function getAddress(lat, lng) {
            selectedLat = lat; selectedLng = lng;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await res.json();
                document.getElementById('picked-address-text').innerText = data.display_name || "ঠিকানা পাওয়া যায়নি";
            } catch (e) {
                document.getElementById('picked-address-text').innerText = "ঠিকানা লোড হচ্ছে না";
            }
        }

        function saveAddressToFirebase() {
            const label = document.getElementById('addr-label').value; 
            const flat = document.getElementById('addr-flat').value;
            const instructions = document.getElementById('addr-instructions').value;
            const geocoded = document.getElementById('picked-address-text').innerText;
            if(!label) return alert("ঠিকানার নাম দিন");
            const fullManual = `${flat ? 'Flat: '+flat+', ' : ''}${geocoded}${instructions ? ' (Instr: '+instructions+')' : ''}`;
            const id = Date.now();
            db.ref(`customers/${currentUser.phone}/addresses/${id}`).set({id, label, fullAddress: fullManual, flat, instructions, lat:selectedLat, lng:selectedLng});
            db.ref(`customers/${currentUser.phone}/activeAddress`).set(fullManual).then(() => location.reload());
        }

        function closeAddressPicker() { document.getElementById('address-picker-modal').classList.add('hidden'); }
        function closeMenu() { document.getElementById('menu-view').classList.add('hidden'); }
        function logout() { localStorage.clear(); location.reload(); }

        function registerUser() {
            const n = document.getElementById('reg-name').value, p = document.getElementById('reg-phone').value;
            if(!n || !p) return alert("সব তথ্য পূরণ করুন");
            db.ref('customers/' + p).set({ name:n, phone:p, activeAddress: "ঠিকানা সেট করা নেই", addresses: {} }).then(() => loginUser(p));
        }

        const savedPhone = localStorage.getItem('khide_user_phone');
        if(savedPhone) loginUser(savedPhone);
    </script>
</body>
</html>